# Phase 9 Quick Reference

## Problem & Solution

| Aspect | Before | After |
|--------|--------|-------|
| Role changes | Saved to DB, but menu cache stale (60s) | Saved to DB, cache invalidated immediately |
| Cache strategy | No invalidation | Tag-based selective invalidation |
| Performance | Fast but inconsistent permissions | Fast AND consistent permissions |
| Pagination | No pagination | Full pagination with Skip/Take |

---

## Key Code Patterns

### Backend Pattern 1: Cache Tagging
```csharp
[OutputCache(Duration = 60, Tags = new[] { "UserMenuTag" })]
public async Task<ActionResult<IEnumerable<MenuItem>>> GetUserMenu()
```

### Backend Pattern 2: Cache Invalidation
```csharp
// Inject in constructor:
private readonly IOutputCacheStore _cacheStore;

// Use in endpoint:
user.RolId = roleChangeDto.NewRoleId;
await _context.SaveChangesAsync();
await _cacheStore.EvictByTagAsync("UserMenuTag", default); // ← Key line
```

### Backend Pattern 3: Pagination
```csharp
[HttpGet("users")]
public async Task<ActionResult<PagedResult<UsuarioResponseDto>>> GetUsers(
    [FromQuery] int pageNumber = 1,
    [FromQuery] int pageSize = 10)
{
    if (pageSize > 100) pageSize = 100;
    
    var query = _context.Usuarios.Include(u => u.Rol).OrderBy(u => u.NombreUsuario);
    var totalCount = await query.CountAsync();
    var usuarios = await query.Skip((pageNumber - 1) * pageSize).Take(pageSize).ToListAsync();
    
    return Ok(new PagedResult<UsuarioResponseDto>(responseDtos, totalCount, pageNumber, pageSize));
}
```

### Frontend Pattern 1: Pagination State
```jsx
const [currentPage, setCurrentPage] = useState(1);
const [totalPages, setTotalPages] = useState(1);

const fetchUsers = async (pageNumber = 1) => {
    const response = await getUsers(pageNumber, 10);
    setUsers(response.data.items || []);
    setTotalPages(response.data.totalPages || 1);
    setCurrentPage(pageNumber);
};

useEffect(() => {
    fetchUsers(currentPage);
}, [currentPage]); // Refetch when page changes
```

### Frontend Pattern 2: Pagination UI
```jsx
<button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1}>
    Anterior
</button>
<span>Página {currentPage} de {totalPages}</span>
<button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages}>
    Siguiente
</button>
```

### Frontend Pattern 3: Dual Property Case Support
```jsx
// Handle both camelCase and PascalCase from backend
const data = response.data;
setUsers(data.items || data.Items || []);
setTotalPages(data.totalPages || data.TotalPages || 1);
setTotalCount(data.totalCount || data.TotalCount || 0);
```

---

## Database Queries Generated

### Pagination Query (Generated by EF Core)
```sql
SELECT COUNT(*)
FROM [Usuarios] AS [u]

-- Then fetch page:
SELECT [u0].[ID], [u0].[Email], [u0].[NombreUsuario], ...
FROM [Usuarios] AS [u0]
INNER JOIN [Roles] AS [r] ON [u0].[RolID] = [r].[ID]
ORDER BY [u0].[NombreUsuario]
OFFSET @__p_0 ROWS FETCH NEXT @__p_1 ROWS ONLY  -- Skip/Take
```

### Cache Invalidation
```
When EvictByTagAsync("UserMenuTag") is called:
- Only cache entries tagged with "UserMenuTag" are removed
- GetUserMenu next request will query database
- GetForos, GetHilos caches remain untouched
```

---

## Endpoints Reference

### GET /api/Auth/menu
- **Cache:** 60 seconds, tagged as "UserMenuTag"
- **Auth:** Required (Bearer token)
- **Returns:** Array of MenuItem objects
- **On Role Change:** Cache invalidated, next request hits DB

### GET /api/Admin/users
- **Pagination:** pageNumber (1+), pageSize (1-100)
- **Returns:** PagedResult<UsuarioResponseDto>
- **Response Format:**
  ```json
  {
    "items": [{ "id": 1, "nombreUsuario": "admin", ... }],
    "totalCount": 15,
    "totalPages": 2,
    "pageNumber": 1,
    "pageSize": 10
  }
  ```

### PUT /api/Admin/users/{id}/role
- **Body:** `{ "newRoleId": 1 }`
- **Action:** Saves to DB, invalidates "UserMenuTag" cache
- **Response:** `{ "message": "...", "userId": 1, "newRoleId": 1 }`

---

## Configuration

### Program.cs (Output Caching)
```csharp
builder.Services.AddOutputCache(options =>
{
    options.AddBasePolicy(builder => 
        builder.Expire(TimeSpan.FromSeconds(60)));
});

app.UseOutputCache();
```

### launchSettings.json (Ports)
```json
"GeneradorDeModelos": {
    "commandName": "Project",
    "dotnetRunMessages": true,
    "launchBrowser": false,
    "applicationUrl": "https://localhost:7145;http://localhost:5153",
    ...
}
```

---

## Common Issues & Solutions

### Issue 1: "IOutputCacheStore type not found"
**Solution:** Add using statement
```csharp
using Microsoft.AspNetCore.OutputCaching;
```

### Issue 2: "Cache not invalidating after role change"
**Cause:** Missing EvictByTagAsync call
**Solution:** Add after SaveChangesAsync():
```csharp
await _cacheStore.EvictByTagAsync("UserMenuTag", default);
```

### Issue 3: "Frontend shows stale user list after deletion"
**Solution:** Refetch current page:
```jsx
await deleteUser(userId);
fetchUsers(currentPage); // Refetch same page
```

### Issue 4: "Pagination shows wrong total pages"
**Cause:** PascalCase vs camelCase mismatch
**Solution:** Support both cases:
```jsx
setTotalPages(data.totalPages || data.TotalPages || 1);
```

---

## Performance Metrics

### Expected Response Times (Cached)
- GetMenu: ~10-20ms (from cache)
- GetForos: ~50-100ms (from cache)
- GetHilos: ~50-100ms (from cache)

### Expected Response Times (Uncached)
- GetMenu (after role change): ~200-300ms (DB query)
- GetUsers page 1: ~150-250ms (COUNT + SKIP/TAKE)

### Cache Hit Ratio (Normal Usage)
- Menu: ~95% (only invalidated on admin role change)
- Foros/Hilos: ~99% (never invalidated except during testing)

---

## Testing Checklist

- [ ] Admin login successful
- [ ] Admin panel loads with pagination
- [ ] Change user role to Administrador
- [ ] Toast shows "must re-login" message
- [ ] User logs out
- [ ] User logs back in
- [ ] User sees /crear-foro in menu ✅
- [ ] Pagination Previous/Next work
- [ ] User count displays correctly
- [ ] Delete user removes from DB
- [ ] After delete, pagination refreshes correctly

---

## Files to Remember

```
Core Implementation:
  /GeneradorDeModelos/Controllers/AuthController.cs (Line 105: GetUserMenu)
  /GeneradorDeModelos/Controllers/AdminController.cs (Lines 20-115)
  /foro-frontend/src/pages/AdminPage.jsx (State + UI)
  /foro-frontend/src/services/apiService.js (getUsers function)

Documentation:
  /PHASE9_CACHE_ARCHITECTURE.md (Full details)
  /PHASE9_CHANGES.md (Diff view)
  /PHASE9_QUICK_REFERENCE.md (This file)
```

---

## Next Steps (Optional)

1. **Monitoring:** Add cache hit rate telemetry
2. **Optimization:** Implement Redis for distributed caching
3. **UX:** Add loading spinners during pagination
4. **Testing:** Add E2E tests for role change flow

---

## Support & Reference

**For detailed architecture:** See PHASE9_CACHE_ARCHITECTURE.md  
**For code changes:** See PHASE9_CHANGES.md  
**For patterns:** See Backend/Frontend Pattern sections above
